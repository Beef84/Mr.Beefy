name: Update Knowledge Base

on:
  push:
    branches: [ main ]
    paths:
      - "wiki/**"
  workflow_dispatch:
    inputs:
      reason:
        description: "Why are you manually deploying?"
        required: false
        default: "Manual trigger"

jobs:
  ingest-knowledge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    # -----------------------------
    # Install Terraform CLI
    # -----------------------------
    - name: Install Terraform
      run: |
        sudo apt-get update && sudo apt-get install -y unzip
        curl -fsSL https://releases.hashicorp.com/terraform/1.9.8/terraform_1.9.8_linux_amd64.zip -o terraform.zip
        unzip terraform.zip
        sudo mv terraform /usr/local/bin/
        terraform -version

    # -----------------------------
    # Load Terraform Outputs
    # -----------------------------
    - name: Load Terraform Outputs
      id: tfout
      working-directory: backend/IaC
      run: |
        terraform init -backend=false >/dev/null

        BUCKET=$(terraform output -raw knowledge_bucket)
        AGENT_ID=$(terraform output -raw agent_id)

        echo "bucket=$BUCKET" >> $GITHUB_OUTPUT
        echo "agent_id=$AGENT_ID" >> $GITHUB_OUTPUT

    # -----------------------------
    # Validate Bucket Exists
    # -----------------------------
    - name: Validate Bucket
      run: |
        if ! aws s3 ls "s3://${{ steps.tfout.outputs.bucket }}" >/dev/null 2>&1; then
          echo "ERROR: Bucket ${{ steps.tfout.outputs.bucket }} does not exist."
          exit 1
        fi

    # -----------------------------
    # Upload Knowledge Files
    # -----------------------------
    - name: Upload Knowledge Files
      run: |
        aws s3 sync knowledge/ s3://${{ steps.tfout.outputs.bucket }}/ --delete

    # -----------------------------
    # Lookup Knowledge Base ID
    # -----------------------------
    - name: Lookup Knowledge Base ID
      id: lookup
      run: |
        KB_ID=$(aws bedrock-agent list-knowledge-bases \
          --query "knowledgeBaseSummaries[?name=='mrbeefy-kb'] | [0].knowledgeBaseId" \
          --output text)

        if [ -z "$KB_ID" ] || [ "$KB_ID" = "None" ]; then
          echo "ERROR: Knowledge Base 'mrbeefy-kb' not found."
          exit 1
        fi

        echo "kb_id=$KB_ID" >> $GITHUB_OUTPUT

    # -----------------------------
    # Trigger KB Ingestion
    # -----------------------------
    - name: Trigger KB Ingestion
      working-directory: backend/cli
      shell: pwsh
      run: |
        ./ingest.ps1 -KbId "${{ steps.lookup.outputs.kb_id }}"

    # -----------------------------
    # Re-associate KB with Agent (DRAFT)
    # -----------------------------
    - name: Associate KB with Agent (DRAFT)
      working-directory: backend/cli
      shell: pwsh
      run: |
        ./associate_kb.ps1 `
          -AgentId "${{ steps.tfout.outputs.agent_id }}" `
          -KbId "${{ steps.lookup.outputs.kb_id }}" `
          -AgentVersion "DRAFT"

    # -----------------------------
    # Done
    # -----------------------------
    - name: Knowledge Update Complete
      run: echo "Knowledge Base updated and ingestion triggered."