name: Update Knowledge Base

on:
  push:
    branches: [ main ]
    paths:
      - "knowledge/**"
  workflow_dispatch:
    inputs:
      reason:
        description: "Why are you manually deploying?"
        required: false
        default: "Manual trigger"

jobs:
  ingest-knowledge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    # -----------------------------
    # Load Knowledge Bucket from SSM
    # -----------------------------
    - name: Load Knowledge Bucket
      id: kb
      run: |
        BUCKET=$(aws ssm get-parameter \
          --name "/mrbeefy/knowledge_bucket" \
          --query "Parameter.Value" \
          --output text)

        if [ -z "$BUCKET" ]; then
          echo "ERROR: Could not load knowledge bucket from SSM."
          exit 1
        fi

        echo "bucket=$BUCKET" >> $GITHUB_OUTPUT

    # -----------------------------
    # Validate Bucket Exists
    # -----------------------------
    - name: Validate Bucket
      run: |
        if ! aws s3 ls "s3://${{ steps.kb.outputs.bucket }}" >/dev/null 2>&1; then
          echo "ERROR: Bucket ${{ steps.kb.outputs.bucket }} does not exist."
          exit 1
        fi

    # -----------------------------
    # Upload Knowledge Files
    # -----------------------------
    - name: Upload Knowledge Files
      run: |
        aws s3 sync knowledge/ s3://${{ steps.kb.outputs.bucket }}/ --delete

    # -----------------------------
    # Lookup Knowledge Base ID
    # -----------------------------
    - name: Lookup Knowledge Base ID
      id: lookup
      run: |
        KB_ID=$(aws bedrock-agent list-knowledge-bases \
          --query "knowledgeBaseSummaries[?name=='mrbeefy-kb'] | [0].knowledgeBaseId" \
          --output text)

        if [ -z "$KB_ID" ] || [ "$KB_ID" = "None" ]; then
          echo "ERROR: Knowledge Base 'mrbeefy-kb' not found."
          exit 1
        fi

        echo "kb_id=$KB_ID" >> $GITHUB_OUTPUT

    # -----------------------------
    # Trigger KB Ingestion
    # -----------------------------
    - name: Trigger KB Ingestion
      working-directory: backend/cli
      shell: pwsh
      run: |
        ./ingest.ps1 -KbId "${{ steps.lookup.outputs.kb_id }}"

    # -----------------------------
    # Done
    # -----------------------------
    - name: Knowledge Update Complete
      run: echo "Knowledge Base updated and ingestion triggered."