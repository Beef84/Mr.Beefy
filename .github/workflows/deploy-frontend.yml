name: Deploy Mr. Beefy Frontend

on:
  push:
    branches: [ main ]
    paths:
      - "frontend/**"

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    # -----------------------------
    # Download API ID Artifact
    # -----------------------------
    - name: Download API Artifact
      uses: actions/download-artifact@v4
      with:
        name: mrbeefy-api-info

    - name: Load API ID
      id: api
      run: |
        source api-info.env
        echo "api_id=$API_ID" >> $GITHUB_OUTPUT
        echo "Using API ID: $API_ID"

    # -----------------------------
    # Build Frontend (Vite)
    # -----------------------------
    - name: Install Node
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install UI Dependencies
      working-directory: frontend/UI
      run: npm install

    - name: Build UI
      working-directory: frontend/UI
      run: npm run build

    # -----------------------------
    # Terraform Init + Apply (Frontend Infra)
    # -----------------------------
    - name: Install Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      working-directory: frontend/IaC
      run: terraform init -upgrade

    - name: Terraform Apply
      working-directory: frontend/IaC
      run: terraform apply -auto-approve -var="api_id=${{ steps.api.outputs.api_id }}"

    # -----------------------------
    # Capture Terraform Outputs
    # -----------------------------
    - name: Capture Terraform Outputs
      id: tfout
      working-directory: frontend/IaC
      run: |
        echo "bucket=$(terraform output -raw frontend_bucket_name)" >> $GITHUB_OUTPUT
        echo "cf_domain=$(terraform output -raw cloudfront_domain_name)" >> $GITHUB_OUTPUT

    # -----------------------------
    # Upload Built UI to S3
    # -----------------------------
    - name: Sync UI to S3
      run: |
        aws s3 sync frontend/UI/dist/ s3://${{ steps.tfout.outputs.bucket }}/ --delete

    # -----------------------------
    # Invalidate CloudFront Cache
    # -----------------------------
    - name: Invalidate CloudFront
      run: |
        DISTRIBUTION_ID=$(aws cloudfront list-distributions \
          --query "DistributionList.Items[?DomainName=='${{ steps.tfout.outputs.cf_domain }}'].Id | [0]" \
          --output text)

        aws cloudfront create-invalidation \
          --distribution-id "$DISTRIBUTION_ID" \
          --paths "/*"

    # -----------------------------
    # Done
    # -----------------------------
    - name: Deployment Complete
      run: echo "Frontend deployed successfully."